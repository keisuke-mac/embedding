# Embedding法でのDOS計算(未完)

以下で使うプログラムは圧縮ファイルとしてsmith上の`/home/kota/Embedding/compressed_file`に置いてあります。使用される場合は必要なものをこのディレクトリからコピーするようにしてください。

## SCF計算におけるgemapw

`Cu_001_7x7_scf_embpot.tgz`を任意のディレクトリにコピーします。次にファイルを解凍をしディレクトリ内に移動してください。ここでの計算はksup1とksup2の２ステップに分かれているので順に説明していきます。

### ksup1
input.datは
```
   0.d0      33.813626d0
  90.d0      33.813626d0
 1         0.d0
 14.1d0    3.5d0                #gmax,gcut

```
param.datは
```
! // parameter file
! // Cu_001_7x7 ksup1
& param

kopr=1
kdsp=0
kvx=0
kvy=0
ksup=1
kinput_e=1
klt_rad=1
/

```
になります。それぞれ`input.dat.ksup1`と`param.dat.ksup1`に保管されているので計算の際はコピーして使用するようにしてください。job.scriptは

```
#!/bin/sh
#SBATCH -J  Cu_7x7_embpot
#SBATCH -p  i8cpu
#SBATCH -N  1
#SBATCH -n  1

module load intel_compiler/2020.2.254
module load intel_mpi/2020.2.254
#Above settings should be consistent with those used in the comparison.

cat $PE_HOSRFILE | awk '{ print$1":"$2/ENVIRON["OMP_NUM_THREADS"]}' >hostfile.$JOB_ID
srun  /home/k0277/k027705/Embedding/gemapw/gemapw.out

rm -f hostfile.$JOB_ID
```
になります。計算の結果出力されるファイルは`kpoint.dat`で、次のステップ(ksup2)で使用します。

`igpo`:gr　原点を１としてgcut内にあるg点にindexを割り振る
`gr`:g点の半径


### ksup2
このステップでは`input.dat` 、`param.dat`の他にいくつか必要なファイルがあり

- kpoint.dat
- d3ps-pot.dat
- d3mt-pot.dat

の三つになります。一つ目の`kpoint.dat`はksup1での出力ファイルで、あとの二つは`L-apw`での計算結果になります。 それぞれd3ps-pot.datは原子球間の領域、d3mt-pot.datは原子球内の領域になります。(編集中)



input.datは
```
   0.d0       4.830518d0
  90.d0       4.830518d0
 2.415259d0    2.415259d0    3.415692d0 
 1         0.d0
 1        90.d0
 1       -90.d0
 1       180.d0
 2         0.d0
 2        45.d0
 2        90.d0
 2       135.d0
 14.1d0    3.5d0    3.5d0
 1
 0.d0    0.d0   2.4d0   2.4d0    ! atomic coordinates
 29.d0   7
 100   200   210   300   310   325    405
 2.d0  2.d0  6.d0  2.d0  6.d0  10.d0  1.d0
 60.d0    32.d0
 3.415692d0     3.415692d0      0.d0
-3.415692d0     3.415692d0      0.d0
 2
 -0.5d0    0.32500628d0   31
```


embedding potentialの作り方ですが、embedding計算では
常に格子面がxy面、真空に向いた表面垂線がz方向です。
Cu_001_1x1_scf_embpot/input.datをご覧ください。
はじめの2行
```
0.d0       4.830518d0
90.d0       4.830518d0
```
 で2次元格子面をx軸から測った角度と長さで指定します。
 (001)面の場合は、1辺がa=4.830518 bohrの正方形です。

 次の1行
 ```
  2.415259d0    2.415259d0    3.415692d0
  ```
 で2つの隣接格子面をつなぐ3番目の格子ベクトルを
 指定します。(001)面の場合、(a/2,a/2,a/sqrt(2))です。

 次の8行は表面系の対称操作
 ```
 1         0.d0
 1        90.d0
 1       -90.d0
 1       180.d0
 2         0.d0
 2        45.d0
 2        90.d0
 2       135.d0
 ```
 です。c4vなので8個操作があります(kopr=8で指定)。前半の4個が回転、
 後半の4個が鏡映です（z軸から見た鏡映面とx軸のなす角度で指定）

 次の
 ```
14.1d0    3.5d0    3.5d0
```
 は平面波のcut-offパラメータです。embedding potentialは
 V(k+g, k+g')と行列で書けますが、この|k+g|の最大値が3.5 a.u.
     (3.5^2=12.25 Ry)であることを指定します。はじめの14.1は
 この3.5の4倍以上の任意の値です。

 次は(001)面の1原子層内の原子の情報です。
 ```
 1　　!原子数
 0.d0    !0.d0   2.4d0   2.4d0　原子x,y,z座標、LAPWの原子球の半径
 29.d0   7　!原子番号、軌道数
 100   200   210   300   310   325    405　　!Cu原子の軌道
 2.d0  2.d0  6.d0  2.d0  6.d0  10.d0  1.d0　!軌道占有電子数
 60.d0    32.d0　!LAPWの原子球のradial meshの刻みの情報
```
となりますが、これらは格子面に依存しません。

 次の
 ```
   3.415692d0     3.415692d0      0.d0
  -3.415692d0     3.415692d0      0.d0
  ```
 がembedding計算の座標系とバルクCu計算の座標系の関係を表します。

 Bulk FCCのCuの計算は、先ほどGoogle driveにuploadした

 Cu-bulk_fcc/input.dat

 を見てください。初めの3行
 ```
  3.415692d0      0.d0          3.415692d0
  3.415692d0      3.415692d0    0.d0
  0.d0            3.415692d0    3.415692d0
```
 が3次元結晶の格子ベクトルをxyz座標で指定したものです。このxyz軸
 は、表面計算のxyz軸とは一致しません。例えば（111）面ではz軸方向は
 (111)方向です。(001)面ではz軸は一致しますが、xy面は45度互いに回転
 しています。

 先ほどの2行
```
  3.415692d0     3.415692d0      0.d0
 -3.415692d0     3.415692d0      0.d0
```
 は、embedding計算の2個の格子ベクトル
```
    　0.d0       4.830518d0
      90.d0      4.830518d0
```
 が3次元バルク系の座標系では
```
  3.415692d0     3.415692d0      0.d0
 -3.415692d0     3.415692d0      0.d0
```
 であることを意味します。これで2つの座標系の関係が一意的に決まります。
 3次元結晶のポテンシャルは



 ＊＊＊
 まとめるとinput.datの最初の3行
 ```
　0.d0       4.830518d0
  90.d0      4.830518d0
 2.415259d0    2.415259d0    3.415692d0
```
 で格子面の構造を指定して、最後の方の2行
```
   3.415692d0     3.415692d0      0.d0
  -3.415692d0     3.415692d0      0.d0
```
 でその格子面とバルク結晶の関係を指定します。他の例として
 (111)面であれば
```
　0.d0       4.830518d0
  60.d0      4.830518d0
 2.415259d0    1.394450d0    3.9441014d0
 -3.415692d0     0.0             3.415692d0
0.d0          -3.415692d0      3.415692d0
```
となります。
param.datは
```
! // parameter file
! // Cu_001_7x7 ksup2
& param

kopr=8
kdsp=0

kt=1
ka=1
korb=7
kmsh=461

klmx=7
klpmx=6

km1=30
km2=30

kfp=1
ksup=2
kbff=3

klt_rad=1
kcnt=1

k2el=0
kdiag=1
kinput_e=1
btyp='sn'
/

```
になります。それぞれ`input.dat.ksup2`と`param.dat.ksup2`に保管されているので計算の際はコピーして使用するようにしてください。job.scriptは

```
#!/bin/sh
#SBATCH -J  Cu_7x7_embpot
#SBATCH -p  i8cpu
#SBATCH -N  1
#SBATCH -n  1

module load intel_compiler/2020.2.254
module load intel_mpi/2020.2.254
#Above settings should be consistent with those used in the comparison.

cat $PE_HOSRFILE | awk '{ print$1":"$2/ENVIRON["OMP_NUM_THREADS"]}' >hostfile.$JOB_ID
srun  /home/k0277/k027705/Embedding/gemapw/gemapw.out

rm -f hostfile.$JOB_ID
```
になります。出力は

- g_emb.dat
- 00.band.dat
- 00.vemb.dat
- 00.output

になります。

また、embeddingポテンシャル作成に用いられた原子座標などのパラメータが`g_emb.dat`に出力されます。このファイルは次の`emapw`での計算で使用します。また`00.vemb.dat`にembeddingポテンシャルが出力されます。


## SCF計算におけるemapw

```
tar -xvzf Cu_001_7x7_scf.tgz
```

でファイルを解凍し、ディレクトリ内に入ります。

- input.dat
- param.dat
- d3ps-pot.dat（FCC Cu 原子球外側の領域のポテンシャル）
- g_emb.dat（表面領域とバルクとの境界面の構造データ）
- orb.dat（DOSを射影する軌道のデータ：s, px, py, pz・・・・）

があることをご確認ください。
<br>
次にサブfolderの./e_pot_scf中に`00.vemb.dat`を用意します(元々あるかもしれませんが中身がないダミーです)。このファイルは`Cu_001_7x7_scf_embpot.tgz`を解凍すれば展開されるので任意のディレクトリで解凍し、コピーするかシンボリックリンクするかしてください。



`input.dat`は
```
   0.d0      33.813626d0
  90.d0      33.813626d0
  1      0.d0   0.d0  0.d0  1.d0
 14.1d0    14.1d0     0.5d0   0.5d0
 3.5d0
 16.d0
 49                     
      0.00000000      0.00000000      2.40000000      2.40000000
      0.00000000      4.83051800      2.40000000      2.40000000
      0.00000000      9.66103600      2.40000000      2.40000000
      0.00000000     14.49155400      2.40000000      2.40000000
      0.00000000     19.32207200      2.40000000      2.40000000
      0.00000000     24.15259000      2.40000000      2.40000000
      0.00000000     28.98310800      2.40000000      2.40000000
      4.83051800      0.00000000      2.40000000      2.40000000
      4.83051800      4.83051800      2.40000000      2.40000000
      4.83051800      9.66103600      2.40000000      2.40000000
      4.83051800     14.49155400      2.40000000      2.40000000
      4.83051800     19.32207200      2.40000000      2.40000000
      4.83051800     24.15259000      2.40000000      2.40000000
      4.83051800     28.98310800      2.40000000      2.40000000
      9.66103600      0.00000000      2.40000000      2.40000000
      9.66103600      4.83051800      2.40000000      2.40000000
      9.66103600      9.66103600      2.40000000      2.40000000
      9.66103600     14.49155400      2.40000000      2.40000000
      9.66103600     19.32207200      2.40000000      2.40000000
      9.66103600     24.15259000      2.40000000      2.40000000
      9.66103600     28.98310800      2.40000000      2.40000000
     14.49155400      0.00000000      2.40000000      2.40000000
     14.49155400      4.83051800      2.40000000      2.40000000
     14.49155400      9.66103600      2.40000000      2.40000000
     14.49155400     14.49155400      2.40000000      2.40000000
     14.49155400     19.32207200      2.40000000      2.40000000
     14.49155400     24.15259000      2.40000000      2.40000000
     14.49155400     28.98310800      2.40000000      2.40000000
     19.32207200      0.00000000      2.40000000      2.40000000
     19.32207200      4.83051800      2.40000000      2.40000000
     19.32207200      9.66103600      2.40000000      2.40000000
     19.32207200     14.49155400      2.40000000      2.40000000
     19.32207200     19.32207200      2.40000000      2.40000000
     19.32207200     24.15259000      2.40000000      2.40000000
     19.32207200     28.98310800      2.40000000      2.40000000
     24.15259000      0.00000000      2.40000000      2.40000000
     24.15259000      4.83051800      2.40000000      2.40000000
     24.15259000      9.66103600      2.40000000      2.40000000
     24.15259000     14.49155400      2.40000000      2.40000000
     24.15259000     19.32207200      2.40000000      2.40000000
     24.15259000     24.15259000      2.40000000      2.40000000
     24.15259000     28.98310800      2.40000000      2.40000000
     28.98310800      0.00000000      2.40000000      2.40000000
     28.98310800      4.83051800      2.40000000      2.40000000
     28.98310800      9.66103600      2.40000000      2.40000000
     28.98310800     14.49155400      2.40000000      2.40000000
     28.98310800     19.32207200      2.40000000      2.40000000
     28.98310800     24.15259000      2.40000000      2.40000000
     28.98310800     28.98310800      2.40000000      2.40000000
 29.d0   7
 100   200   210   300   310   325    405
 2.d0  2.d0  6.d0  2.d0  6.d0  10.d0  1.d0
 60.d0    32.d0
 2
 -0.5d0    0.32500628d0   15
 31
 6          1        40
 0.9975     1.d-5
```



<br>
最後から二行目について
```
6          1        40
```

の欄でiterationを指定することができます。初めの６は電子のmixingを指定しています。最新6iterationのinputとoutputを混ぜて次のiterationの電子密度を計算します。次の１は１stを意味し最初から始めることを表しており、計算結果の収束が不十分なときに変更を加えて再度計算する形になります。最後の行はどれだけiterationを回すかを指定でき、この場合40iterationです。
`param.dat`は
job scriptは

```
#!/bin/sh
#SBATCH -J  Cu_surface
#SBATCH -p  cmdinteractive
#SBATCH -N  1
#SBATCH -n  64

module load intel_compiler/2020.2.254
module load intel_mpi/2020.2.254
#Above settings should be consistent with those used in the comparison.

cat $PE_HOSRFILE | awk '{ print$1":"$2/ENVIRON["OMP_NUM_THREADS"]}' >hostfile.$JOB_ID
srun  ~/EmApw/emapw.out
rm -f hostfile.$JOB_ID
```

です。ただし`emapw.out`のパスはご自身のものを指定してください。またコンパイラもご自身の環境により適宜変更してください。


計算の収束状況は
```
grep "jte, rms" 00.output
```
により確認できます。rmsは入力電子密度と出力電子密度の差をユニットセルで平均したものです（Hartree原子単位）。
<br>
計算が収束すると
```
grep evcm 00.output
```
により真空準位を確認することができます。今回のCuのフェルミエネルギー$\mathrm{E}_F$は$0.325\, \mathrm{Hartree}$なので仕事関数は$(\mathrm{evcm}-0.325)\times 27.211386\,eV$と計算でき、結果から仕事関数は4.59eVとなるはずです。

## DOS計算でのembeddingポテンシャル
DOS計算でもSCF同様embeddingポテンシャルの計算が必要です。またこの時もSCF同様ksup1とksup2の二段階あります。ただksup１の出力である`kpoint.dat`はscf計算の時のものを使えば良いので、ここではksup2の計算について示します。<br>
以下のファイルをディレクトリに準備してください。

- kpoin.dat(scf計算での出力結果)
- d3ps-pot.dat
- d3mt-pot.dat
  
`input.dat`
```
   0.d0       4.830518d0
  90.d0       4.830518d0
 2.415259d0    2.415259d0    3.415692d0 
 1         0.d0
 1        90.d0
 1       -90.d0
 1       180.d0
 2         0.d0
 2        45.d0
 2        90.d0
 2       135.d0
 14.1d0    3.5d0    3.5d0
 1
 0.d0    0.d0   2.4d0   2.4d0    ! atomic coordinates
 29.d0   7
 100   200   210   300   310   325    405
 2.d0  2.d0  6.d0  2.d0  6.d0  10.d0  1.d0
 60.d0    32.d0
 3.415692d0     3.415692d0      0.d0
-3.415692d0     3.415692d0      0.d0
 0
 241  -0.04248675d0   0.39850488d0   9.187d-4
```
scf計算の時の`input.dat`と比較すると異なるのは最後の二行だけなことがわかります。
これは
scf計算の場合
```
2  #半円周を意味
-0.5d0    0.32500628d0  31  #エネルギー下端、上端、点数
```
でしたが、DOS計算では
```
0  #　実エネルギー軸に平行な線分
241  -0.04248675d0   0.39850488d0   9.187d-4  #点数、実エネルギー下端、上端、エネルギーの虚部
```
になります。またジョブスクリプトは
```
#$ -S /bin/bash
#$ -cwd
#$ -q xh1.q
#$ -pe x24 24
#$ -N Cu(100)7x7_embpot
#$ -j y

module load intel/2020.2.254
module load intelmpi/2020.2.254
#Above settings should be consistent with those used in the comparison.

#disable OPENMP parallelism
export OMP_NUM_THREADS=1
export I_MPI_ADJUST_ALLGATHERV=2
export I_MPI_PIN=1

cat $PE_HOSRFILE | awk '{ print$1":"$2/ENVIRON["OMP_NUM_THREADS"]}' >hostfile.$JOB_ID
mpirun -n 1  /home/kota/Embedding/gemapw/gemapw.out
rm -f hostfile.$JOB_ID
```

## DOS計算
これもscf計算の時と同様にディレクトリ内に`e_pot_dos`としたサブディレクトリを作成し、その中に先ほどの計算結果である`00.vemb.dat`をコピーするかシンボリックリンクしてください。<br>
またscf計算で収束した電荷密度を
```
cp achgn.dat achg.dat
```
で保存します。DOS計算ではSCF電子密度を、achg.datから読み込みます。
<br>
ディレクトリ内に置いておくファイルは
- d3ps-pot.dat
- d3mt-pot.dat
- g_emb.dat
- orb.dat
  
になります。
<br>
`input.dat`
```
   0.d0      33.813626d0
  90.d0      33.813626d0
  1      0.d0   0.d0  0.d0  1.d0
 14.1d0    14.1d0     0.5d0   0.5d0
 3.5d0
 16.d0
 49                     
      0.00000000      0.00000000      2.40000000      2.40000000
      0.00000000      4.83051800      2.40000000      2.40000000
      0.00000000      9.66103600      2.40000000      2.40000000
      0.00000000     14.49155400      2.40000000      2.40000000
      0.00000000     19.32207200      2.40000000      2.40000000
      0.00000000     24.15259000      2.40000000      2.40000000
      0.00000000     28.98310800      2.40000000      2.40000000
      4.83051800      0.00000000      2.40000000      2.40000000
      4.83051800      4.83051800      2.40000000      2.40000000
      4.83051800      9.66103600      2.40000000      2.40000000
      4.83051800     14.49155400      2.40000000      2.40000000
      4.83051800     19.32207200      2.40000000      2.40000000
      4.83051800     24.15259000      2.40000000      2.40000000
      4.83051800     28.98310800      2.40000000      2.40000000
      9.66103600      0.00000000      2.40000000      2.40000000
      9.66103600      4.83051800      2.40000000      2.40000000
      9.66103600      9.66103600      2.40000000      2.40000000
      9.66103600     14.49155400      2.40000000      2.40000000
      9.66103600     19.32207200      2.40000000      2.40000000
      9.66103600     24.15259000      2.40000000      2.40000000
      9.66103600     28.98310800      2.40000000      2.40000000
     14.49155400      0.00000000      2.40000000      2.40000000
     14.49155400      4.83051800      2.40000000      2.40000000
     14.49155400      9.66103600      2.40000000      2.40000000
     14.49155400     14.49155400      2.40000000      2.40000000
     14.49155400     19.32207200      2.40000000      2.40000000
     14.49155400     24.15259000      2.40000000      2.40000000
     14.49155400     28.98310800      2.40000000      2.40000000
     19.32207200      0.00000000      2.40000000      2.40000000
     19.32207200      4.83051800      2.40000000      2.40000000
     19.32207200      9.66103600      2.40000000      2.40000000
     19.32207200     14.49155400      2.40000000      2.40000000
     19.32207200     19.32207200      2.40000000      2.40000000
     19.32207200     24.15259000      2.40000000      2.40000000
     19.32207200     28.98310800      2.40000000      2.40000000
     24.15259000      0.00000000      2.40000000      2.40000000
     24.15259000      4.83051800      2.40000000      2.40000000
     24.15259000      9.66103600      2.40000000      2.40000000
     24.15259000     14.49155400      2.40000000      2.40000000
     24.15259000     19.32207200      2.40000000      2.40000000
     24.15259000     24.15259000      2.40000000      2.40000000
     24.15259000     28.98310800      2.40000000      2.40000000
     28.98310800      0.00000000      2.40000000      2.40000000
     28.98310800      4.83051800      2.40000000      2.40000000
     28.98310800      9.66103600      2.40000000      2.40000000
     28.98310800     14.49155400      2.40000000      2.40000000
     28.98310800     19.32207200      2.40000000      2.40000000
     28.98310800     24.15259000      2.40000000      2.40000000
     28.98310800     28.98310800      2.40000000      2.40000000
 29.d0   7
 100   200   210   300   310   325    405
 2.d0  2.d0  6.d0  2.d0  6.d0  10.d0  1.d0
 60.d0    32.d0
 0
 241  -0.04248675d0   0.39850488d0   9.187d-4
 6          7         7
 0.9975     1.d-5
 2
 -0.5d0    0.32500628d0   15
```
です。先ほどのembeddingポテンシャルと同様に実軸方向での積分になります。
`param.dat`
```
! // parameter file
! // Cu_001_7x7
& param
klt_rad=1
kit=6
kopr=1
kdsp=0
kvx=0
kvy=0
kt=1
ka=49
korb=7
klmx=7 
kltx=6
klds=3
krdo=1
klh=1
kfp=1
kcnt=1
kcl=49
kbff=3
k_input_e=1
kgga=1
kdir_v='./e_pot_dos/'
k_pg=1
k_mxbc=5000000
k_vft_mpi=1
k_cmpg2=0
k_pgauto=1
nom='pbe '
/
```
ジョブスクリプト`qsub.sh`は
```
#$ -S /bin/bash
#$ -cwd
#$ -q x20.q
#$ -pe x52 104
#$ -N Cu(100)7x7
#$ -j y

module load intel/2020.2.254
module load intelmpi/2020.2.254
#Above settings should be consistent with those used in the comparison.

#disable OPENMP parallelism
export OMP_NUM_THREADS=1
export I_MPI_ADJUST_ALLGATHERV=2
export I_MPI_PIN=1

cat $PE_HOSRFILE | awk '{ print$1":"$2/ENVIRON["OMP_NUM_THREADS"]}' >hostfile.$JOB_ID
mpirun -n 64  /home/kota/Embedding/EmApw/emapw.out
rm -f hostfile.$JOB_ID
```
で実行しました。

でプログラムを走らせます。こちらは、SCALAPACKで行列を計算しますので1-k点でも、多数のMPIプロセスで計算できます（例えば64）。数時間？で計算が終了します。DOSの出力ファイルは`00.dos.dat`になります。

![dos](dos.eps)
